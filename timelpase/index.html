<!doctype html>
<html>
  <head>
    <title>This is the title of the webpage!</title>
    <style>
      div {
        /* must double percent as this is a c-style format file */
        width:100%;
        text-align:center;
      }
    </style>
  </head>
  <body>
    <script>
      let frame = 0;
      let lastframe = 0;
      let pauseframe = 0;
      let interval = 500;
      //let base = '%s';
      //let folder;// = '%s';
      let url;// = 'http://'+base+'/fs'+folder;
      let pic;
      let framespan;
      let framedisplay;
      let framedone = 1;
      let framecount = 1;

      let currfolder;

      function pause(){
        pauseframe = 1;
      }
      function resume(){
        pauseframe = 0;
      }
      function restart(){
        pauseframe = 0;
        frame = 0;
      }
      function incr(){
        if (+frame < +framecount-1){
          frame = +frame + 1;
          slider.value = +frame;
        }
      }
      function decr(){
        if (+frame > 0){
          frame = +frame - 1;
          slider.value = +frame;
        }
      }
      let frametimer;
      function showframe(){
          if (!frametimer){
            frametimer = setTimeout(async ()=>{
              clearTimeout(frametimer);
              frametimer = null;
              if (!framedone){
                // if we did not get the last frame, just wait a little longer.
                console.log('waiting last complete');
                showframe();
                return;
              }
              lastframe = frame;
              let jsonData = {time:'unknown'};
              try{
                const response = await fetch(url+'frame'+frame+'.json');
                jsonData = await response.json();
              } catch(e){
                console.error(e);
              }
              pic.src = url+'frame'+frame+'.jpg';
              framedone = 0;
              framespan.innerText = frame+':'+jsonData.time;
              framedisplay.innerText = ''+frame + '/'+slider.max;
            }, 100);
          }
        }

      function sliderchange(val){
        frame = +val;
        showframe();
      }
      function intervalchange(val){
        interval = +val;
        let f = document.getElementById('frameinterval');
        f.innerText = 'Frame Interval:'+interval;
      }
      function sleep(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
      }

      window.onload=()=>{
        pic = document.getElementById('image')
        framespan = document.getElementById('frame')
        framedisplay = document.getElementById('framecounter');
        let slider = document.getElementById('slider');
        framedone = 1;

        pic.onload =()=>{
          framedone = 1;
        };
        pic.onerror =()=>{
          framedone = 1;
        };


        async function doit(){
            let folderesp = await fetch('./folders.json');
            const folders = await folderesp.json();

            async function seturl(f){
                currfolder = f;
                url = './'+f+'/';
                try{
                    const response = await fetch(url+'config.json');
                    const jsonData = await response.json();
                    //console.log(jsonData);
                    framecount = jsonData.frame;
                    // framecount is the NEXT frame it will capture.
                    slider.max = +framecount-2;
                    lastframe = 0;
                    let folderel = document.getElementById('folder');
                    folderel.innerText = f;

                    return true;
                } catch(e) {
                    return false;
                }
            };

            if (folders.folders){
                for (let i = 0; i < folders.folders.length; i++){
                    if (await seturl(folders.folders[i])){
                        break;
                    }
                }
            }

            let foldersel = document.getElementById('folders');
            for (let i = 0; i < folders.folders.length; i++){
                let f = folders.folders[i];
                let b = document.createElement('BUTTON');
                b.innerText = f;
                b.onclick = async (ev)=>{
                    if (ev.altKey){
                        if (window.confirm('Do you wish to delete '+f+' and all contents?')){
                            //http://192.168.1.190/cs?c2=166&c1=zapfolder%20test
                            let tascmd = 'http://'+location.host+'/cm?cmnd=zapimagefolder%20'+f;
                            let resp = await fetch(tascmd)
                            const res = await resp.text();
                            console.log(res);
                            // force a refresh in 3s, after TAS has updated out folder list
                            setTimeout(()=>{
                                window.location = window.location;
                            }, 3000)
                        }
                    } else {
                        seturl(f);
                    }
                };
                foldersel.appendChild(b);
            }

            let updatecounter = 10;

            while (1){
              if (!pauseframe || (+frame !== +lastframe)){
                showframe();
              }
              await sleep(interval);

              updatecounter--;
              if (!updatecounter){
                // refresh our total available frames
                try{
                    const response = await fetch(url+'config.json');
                    const jsonData = await response.json();
                    //console.log(jsonData);
                    let slider = document.getElementById('slider');
                    let framecount = +jsonData.frame;
                    // framecount is the NEXT frame it will capture.
                    slider.max = framecount-2;
                    updatecounter = 10;
                } catch(e){
                  console.error(e);
                }
              }
              if (frame == framecount-1){
                pauseframe = 1;
              }
              if (!pauseframe){
                incr();
              }
            }
            pic.src = null;
        }
        doit();
      };
    </script>
    <div id="folders" class="slidecontainer">
    </div>
    <div class="slidecontainer">
      <p>Timelapse <span id="folder"></span><span id="frame"></span></span></p>
    </div>
    <div class="slidecontainer">
      <image id="image"></image>
    </div>
    <div class="slidecontainer">
      <button onclick="pause()">Pause</button>
      <button onclick="resume()">Resume</button>
      <button onclick="restart()">Restart</button>
    </div>
    <div class="slidecontainer">
      <button onclick="decr()"> &LT; </button>
      <input id="slider" type="range" min="0" max="100" value="0" class="slider" onchange="sliderchange(this.value)">
      <button onclick="incr()"> &GT; </button>
      <span id="framecounter"></span>
    </div>
    <div class="slidecontainer">
      <input id="interval" type="range" min="200" max="5000" value="500" class="slider" onchange="intervalchange(this.value)">
      <span id="frameinterval">Frame Interval:500</span>
    </div>
  </body>
</html>